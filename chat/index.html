<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hackathon Flow Blockchain Agents</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }
        .flow-balance {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #000;
            border: 1px solid #00ff00;
            padding: 10px 15px;
            border-radius: 5px;
            font-family: monospace;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .flow-balance .flow-icon {
            width: 20px;
            height: 20px;
            display: inline-block;
            vertical-align: middle;
        }
        .flow-balance .balance {
            color: #00ff00;
            font-weight: bold;
        }
        .flow-balance.loading {
            opacity: 0.5;
        }
        .flow-balance .label {
            color: #888;
            font-size: 10px;
            text-transform: uppercase;
        }
        .debug-panel {
            background: #000;
            border: 1px solid #00ff00;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        input, button {
            background: #000;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 10px;
            margin: 5px;
            font-family: monospace;
            display: inline-block;
            vertical-align: middle;
        }
        button:hover {
            background: #00ff00;
            color: #000;
            cursor: pointer;
        }
        #messages {
            background: #000;
            border: 1px solid #00ff00;
            padding: 15px;
            min-height: 300px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 10px;
        }
        .message {
            position: relative;
            margin: 10px 0;
            padding: 10px;
            padding-right: 40px;
            border-left: 3px solid #00ff00;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .copy-btn {
            display: inline-block;
            background: #000;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 3px 8px;
            font-size: 12px;
            cursor: pointer;
            font-family: monospace;
            opacity: 0.3;
            transition: opacity 0.2s;
            margin-left: 10px;
            vertical-align: middle;
        }
        .message:hover .copy-btn {
            opacity: 1;
        }
        .copy-btn:hover {
            background: #00ff00;
            color: #000;
        }
        .copy-btn.copied {
            background: #00ff00;
            color: #000;
            opacity: 1;
        }
        .message h1, .message h2, .message h3 {
            color: #00ff00;
            margin: 10px 0;
        }
        .message strong {
            color: #00ffff;
            font-weight: bold;
        }
        .message em {
            font-style: italic;
        }
        .error {
            color: #ff0000;
            border-color: #ff0000;
        }
        .info {
            color: #00ffff;
            border-color: #00ffff;
        }
        .success {
            color: #00ff00;
            border-color: #00ff00;
        }
    </style>
</head>
<body>
    <!-- Flow Balance Display -->
    <div class="flow-balance" id="flowBalance">
        <span class="flow-icon">üí∞</span>
        <div>
            <div class="label">FLOW Balance</div>
            <div class="balance" id="balanceAmount">Carregando...</div>
        </div>
    </div>

    <div class="container">
        <h1>üîß Hackathon Flow Blockchain Agents</h1>

        <div id="messages"></div>

        <div style="display: flex; align-items: center; gap: 5px;">
            <input type="text" id="messageInput" placeholder="Digite sua mensagem..." style="flex: 1; max-width: 400px;">
            <button onclick="sendMessage()">Enviar</button>
            <button onclick="testConnection()">Testar API</button>
            <button onclick="clearDebug()">Limpar</button>
        </div>

        <div class="debug-panel" id="status">
            [STATUS] Inicializando...
        </div>

        <div class="debug-panel" id="debug">
            [DEBUG] Console de debug ativo
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8991';
        let sessionId = null;
        const FLOW_ADDRESS = '0x36395f9dde50ea27'; // Nossa conta com 101,000 FLOW

        // Fun√ß√£o para buscar e atualizar o saldo Flow
        async function updateFlowBalance() {
            const balanceDiv = document.getElementById('flowBalance');
            const balanceAmount = document.getElementById('balanceAmount');

            try {
                balanceDiv.classList.add('loading');

                // Primeiro tenta buscar do nosso backend
                let response = await fetch(`${API_URL}/api/flow/balance`);

                if (!response.ok) {
                    // Se falhar, busca direto da API Flow
                    response = await fetch(`https://rest-testnet.onflow.org/v1/accounts/${FLOW_ADDRESS}`);
                    const data = await response.json();

                    if (data.balance !== undefined) {
                        const flowBalance = (parseInt(data.balance) / 100000000).toFixed(4);
                        balanceAmount.textContent = `${flowBalance} FLOW`;
                    } else {
                        balanceAmount.textContent = 'Erro ao carregar';
                    }
                } else {
                    // Usa resposta do backend
                    const data = await response.json();
                    balanceAmount.textContent = data.balance_formatted || `${data.balance.toFixed(4)} FLOW`;
                }

                balanceDiv.classList.remove('loading');

                // Calcular energia do submarino (menos FLOW = mais pr√≥ximo da superf√≠cie)
                const balance = parseFloat(balanceAmount.textContent.replace(',', ''));
                const maxBalance = 101000; // Saldo inicial aproximado
                const energiaUsada = maxBalance - balance;
                const percentualEnergia = Math.max(0, Math.min(100, (energiaUsada / 1000) * 100)); // Cada 1000 FLOW = 100% energia

                // Criar barra de progresso
                const totalBarras = 10;
                const barrasPreenchidas = Math.round((percentualEnergia / 100) * totalBarras);
                const barrasVazias = totalBarras - barrasPreenchidas;
                const barraProgresso = '‚ñà'.repeat(barrasPreenchidas) + '‚ñë'.repeat(barrasVazias);

                // Calcular profundidade (0% energia = 200m fundo, 100% energia = 0m superf√≠cie)
                const profundidade = Math.round(200 - (percentualEnergia * 2));
                let statusProfundidade = '';
                let alertaOxigenio = '';

                if (profundidade <= 10) {
                    statusProfundidade = 'üåÖ Superf√≠cie!';
                    alertaOxigenio = '‚úÖ O‚ÇÇ OK';
                } else if (profundidade <= 50) {
                    statusProfundidade = '‚òÄÔ∏è Raso';
                    alertaOxigenio = 'üå¨Ô∏è O‚ÇÇ Est√°vel';
                } else if (profundidade <= 100) {
                    statusProfundidade = 'üåä M√©dio';
                    alertaOxigenio = 'üí® O‚ÇÇ Limitado';
                } else if (profundidade <= 150) {
                    statusProfundidade = 'üåë Profundo';
                    alertaOxigenio = 'ü´ß O‚ÇÇ CR√çTICO!';
                } else {
                    statusProfundidade = 'üíÄ Abissal';
                    alertaOxigenio = '‚ö†Ô∏è RISCO IMPLOS√ÉO!';
                }

                log(`‚ö° Energia: ${barraProgresso} ${percentualEnergia.toFixed(1)}% | üìç ${profundidade}m ${statusProfundidade} | ${alertaOxigenio} | üí∞ Saldo: ${balanceAmount.textContent} FLOW`);

            } catch (error) {
                console.error('Erro ao buscar saldo Flow:', error);
                balanceAmount.textContent = 'Offline';
                balanceDiv.classList.remove('loading');
            }
        }

        // Atualizar saldo a cada 30 segundos
        setInterval(updateFlowBalance, 30000);

        // Buscar saldo ao carregar a p√°gina
        window.addEventListener('load', () => {
            updateFlowBalance();
        });

        function log(message, type = 'info') {
            const debugPanel = document.getElementById('debug');
            const timestamp = new Date().toLocaleTimeString();
            debugPanel.innerHTML += `\n[${timestamp}] ${message}`;
            debugPanel.scrollTop = debugPanel.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }

        function updateStatus(message, type = 'info') {
            const statusPanel = document.getElementById('status');
            statusPanel.className = `debug-panel ${type}`;
            statusPanel.textContent = `[STATUS] ${message}`;
        }

        function renderMarkdown(text) {
            // Converte markdown b√°sico para HTML
            return text
                // Headers
                .replace(/^### (.*?)$/gm, '<h3>$1</h3>')
                .replace(/^## (.*?)$/gm, '<h2>$1</h2>')
                .replace(/^# (.*?)$/gm, '<h1>$1</h1>')
                // Bold
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Italic
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Code blocks
                .replace(/```([\s\S]*?)```/g, '<pre style="background:#0a0a0a;padding:10px;border:1px solid #00ff00;overflow-x:auto;">$1</pre>')
                // Inline code
                .replace(/`([^`]+)`/g, '<code style="background:#0a0a0a;padding:2px 4px;border:1px solid #00ff00;">$1</code>')
                // Lists
                .replace(/^- (.*?)$/gm, '‚Ä¢ $1')
                // Line breaks
                .replace(/\n/g, '<br>');
        }

        let messageIdCounter = 0;
        let currentStreamingMessageDiv = null;

        function addMessage(content, isUser = false) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            const messageId = `msg-${messageIdCounter++}`;
            messageDiv.className = `message ${isUser ? 'info' : 'success'}`;
            messageDiv.id = messageId;

            // Cria container para o conte√∫do
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            // Renderiza markdown para mensagens do Claude
            if (!isUser) {
                contentDiv.innerHTML = `<span style="color: ${isUser ? '#00ffff' : '#00ff00'}">ü§ñ CLAUDE:</span><br>${renderMarkdown(content)}`;
            } else {
                contentDiv.innerHTML = `<span style="color: #00ffff">üë§ USER:</span><br>${content.replace(/\n/g, '<br>')}`;
            }

            messageDiv.appendChild(contentDiv);

            // Adiciona bot√£o de copiar no final
            const copyBtn = document.createElement('button');
            copyBtn.className = 'copy-btn';
            copyBtn.textContent = 'üìã';
            copyBtn.onclick = () => copyMessage(content, copyBtn);

            messageDiv.appendChild(copyBtn);
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            // Se n√£o for do usu√°rio, guarda refer√™ncia para streaming
            if (!isUser) {
                currentStreamingMessageDiv = messageDiv;
            }
        }

        function updateStreamingMessage(content, isUser = false) {
            if (!currentStreamingMessageDiv) {
                // Se n√£o h√° mensagem de streaming, cria uma nova
                addMessage(content, isUser);
                return;
            }

            // Atualiza o conte√∫do da mensagem existente
            const contentDiv = currentStreamingMessageDiv.querySelector('.message-content');
            if (contentDiv) {
                contentDiv.innerHTML = `<span style="color: #00ff00">ü§ñ CLAUDE:</span><br>${renderMarkdown(content)}`;

                // Atualiza o bot√£o de copiar com o novo conte√∫do
                const copyBtn = currentStreamingMessageDiv.querySelector('.copy-btn');
                if (copyBtn) {
                    copyBtn.onclick = () => copyMessage(content, copyBtn);
                }

                // Mant√©m o scroll no final
                const messagesDiv = document.getElementById('messages');
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }

        async function copyMessage(text, button) {
            try {
                // Remove tags HTML para copiar apenas o texto puro
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = renderMarkdown(text);
                const plainText = tempDiv.textContent || tempDiv.innerText || text;

                await navigator.clipboard.writeText(plainText);

                // Feedback visual
                const originalText = button.textContent;
                button.textContent = '‚úÖ Copiado!';
                button.classList.add('copied');

                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);

                log('Mensagem copiada para clipboard');
            } catch (err) {
                log('Erro ao copiar: ' + err.message, 'error');
                // Fallback para browsers antigos
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    button.textContent = '‚úÖ Copiado!';
                    setTimeout(() => {
                        button.textContent = 'üìã';
                    }, 2000);
                } catch (err) {
                    log('Fallback de c√≥pia tamb√©m falhou', 'error');
                }
                document.body.removeChild(textArea);
            }
        }

        async function testConnection() {
            log('Testando conex√£o com API...');

            try {
                // Teste 1: Health Check
                log('Teste 1: Health Check');
                const healthResponse = await fetch(`${API_URL}/api/health`);
                if (healthResponse.ok) {
                    const health = await healthResponse.json();
                    log(`‚úÖ Health OK: ${JSON.stringify(health)}`, 'success');
                    updateStatus('API Online', 'success');
                } else {
                    log(`‚ùå Health falhou: ${healthResponse.status}`, 'error');
                    updateStatus('API Offline', 'error');
                }

                // Teste 2: SDK Status
                log('Teste 2: SDK Status');
                const sdkResponse = await fetch(`${API_URL}/api/sdk-status`);
                if (sdkResponse.ok) {
                    const sdk = await sdkResponse.json();
                    log(`‚úÖ SDK Status: ${JSON.stringify(sdk)}`, 'success');
                } else {
                    log(`‚ùå SDK Status falhou: ${sdkResponse.status}`, 'error');
                }

            } catch (error) {
                log(`‚ùå Erro de conex√£o: ${error.message}`, 'error');
                updateStatus('Erro de Conex√£o', 'error');
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message) {
                log('‚ö†Ô∏è Mensagem vazia', 'error');
                return;
            }

            log(`üì§ Enviando: "${message}"`);
            addMessage(message, true);
            input.value = '';
            updateStatus('Enviando mensagem...', 'info');

            // Limpa mensagem de streaming anterior
            currentStreamingMessageDiv = null;

            const payload = {
                message: message,
                project_id: 'neo4j-agent'
            };

            // S√≥ adicionar session_id se existir
            if (sessionId) {
                payload.session_id = sessionId;
            }

            log(`Payload: ${JSON.stringify(payload)}`);

            try {
                const response = await fetch(`${API_URL}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                log(`Response status: ${response.status}`);
                log(`Response headers: ${JSON.stringify([...response.headers.entries()])}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                updateStatus('Recebendo resposta...', 'info');

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let fullResponse = '';

                let streamBuffer = '';  // Buffer para acumular chunks de texto

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));

                                // Log mais limpo baseado no tipo de evento
                                if (data.type === 'session_created' && data.session_id) {
                                    sessionId = data.session_id;
                                    log(`üìå Sess√£o criada: ${data.session_id}`);
                                }
                                else if (data.type === 'processing') {
                                    log('‚è≥ Processando...');
                                    updateStatus('Claude est√° processando...', 'info');
                                }
                                else if (data.type === 'content' || data.type === 'text' || data.type === 'text_chunk') {
                                    const content = data.content || data.text || '';
                                    fullResponse += content;

                                    // Atualiza a mensagem em tempo real
                                    updateStreamingMessage(fullResponse, false);

                                    // Log para debug
                                    if (content.length > 0) {
                                        log(`üí¨ Streaming: ${content.substring(0, 50)}${content.length > 50 ? '...' : ''}`);
                                    }
                                }
                                else if (data.type === 'done') {
                                    log('‚úÖ Resposta completa');
                                    updateStatus('Resposta recebida', 'success');
                                    // Garante que a mensagem final est√° completa
                                    if (fullResponse) {
                                        updateStreamingMessage(fullResponse, false);
                                    }
                                    // Limpa a refer√™ncia para pr√≥xima mensagem
                                    currentStreamingMessageDiv = null;
                                    break;
                                }
                                else if (data.type === 'tool_use') {
                                    log(`üì° tool_use: ${data.name || 'ferramenta'}`);
                                }
                                else if (data.type === 'tool_result') {
                                    log(`üîß tool_result recebido`);
                                }
                                else if (data.type === 'error') {
                                    log(`‚ùå Erro: ${data.error}`, 'error');
                                    updateStatus('Erro na resposta', 'error');
                                    break;
                                }
                                else if (data.type === 'result') {
                                    log(`üìä Resultado: ${JSON.stringify(data).substring(0, 100)}...`);
                                    continue;
                                }
                                else if (data.type) {
                                    log(`üîî Evento: ${data.type}`);
                                    continue;
                                }

                            } catch (err) {
                                log(`‚ö†Ô∏è Erro ao parsear: ${err.message}`, 'error');
                            }
                        }
                    }
                }

                if (!fullResponse) {
                    log('‚ö†Ô∏è Resposta vazia', 'error');
                    updateStatus('Resposta vazia', 'error');
                }

            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
                log(`Stack: ${error.stack}`, 'error');
                updateStatus(`Erro: ${error.message}`, 'error');
                addMessage(`Erro: ${error.message}`, false);
            }
        }

        function clearDebug() {
            document.getElementById('debug').innerHTML = '[DEBUG] Console limpo';
            document.getElementById('messages').innerHTML = '';
            log('Console limpo');
        }

        // Enter para enviar
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Fun√ß√£o para verificar saldo Flow
        async function checkFlowBalance() {
            log('üí∞ Consultando saldo Flow...');
            updateStatus('Consultando blockchain Flow...', 'info');

            // Envia mensagem perguntando o saldo
            const input = document.getElementById('messageInput');
            input.value = 'Qual o saldo da minha conta Flow 0x25f823e2a115b2dc?';
            await sendMessage();
        }

        // Inicializa√ß√£o
        window.addEventListener('load', () => {
            testConnectionSilent();
            document.getElementById('messageInput').focus();
        });

        async function testConnectionSilent() {
            try {
                const response = await fetch(`${API_URL}/api/health`);
                if (response.ok) {
                    updateStatus('‚úÖ Conectado ao backend', 'success');
                } else {
                    updateStatus('‚ö†Ô∏è Backend offline', 'error');
                }
            } catch (error) {
                updateStatus('‚ùå Erro de conex√£o', 'error');
            }
        }
    </script>
</body>
</html>