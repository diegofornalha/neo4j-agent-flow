#!/usr/bin/env python3
"""
Sistema de Gerenciamento de NFT do Surfista
Permite criar NFTs e adicionar conhecimento √† bag
"""

import json
import time
from typing import Dict, Any, Optional

class SurfistaNFTManager:
    def __init__(self):
        self.contract_address = "0x25f823e2a115b2dc"
        self.surfistas_registrados = {}  # Cache local dos surfistas
        self.nome_registry = {}  # Registro de nomes para evitar duplicatas

    def resgatar_surfista(self, nome: str, wallet_address: str) -> Dict[str, Any]:
        """
        Resgata um surfista criando sua NFT √∫nica
        Se o nome j√° existir, adiciona #2, #3, etc.

        Args:
            nome: Nome do surfista (ex: "Diego")
            wallet_address: Endere√ßo da carteira do surfista

        Returns:
            Informa√ß√µes da transa√ß√£o e ID da NFT
        """

        # Verificar se o nome j√° existe e criar nome √∫nico
        nome_base = nome
        nome_final = nome

        if nome_base in self.nome_registry:
            # Nome j√° existe, adicionar n√∫mero
            self.nome_registry[nome_base] += 1
            nome_final = f"{nome_base}#{self.nome_registry[nome_base]}"
        else:
            # Primeiro surfista com esse nome
            self.nome_registry[nome_base] = 1

        # Simular cria√ß√£o da NFT (em produ√ß√£o seria uma transa√ß√£o real)
        nft_id = len(self.surfistas_registrados)
        timestamp = time.time()

        surfista_data = {
            "id": nft_id,
            "nome": nome_final,
            "nome_base": nome_base,
            "wallet": wallet_address,
            "data_resgate": timestamp,
            "profundidade_atual": 200,  # Come√ßa no fundo
            "energia_gasta": 0.0,
            "pontos_total": 100,  # Bonus inicial por ser resgatado
            "bag_de_conhecimento": [
                {
                    "tipo": "conquista",
                    "descricao": "üèÑ Resgatado pelo submarino!",
                    "pontos": 100,
                    "timestamp": timestamp
                }
            ],
            "conquistas": {
                "Flow Master": True  # NFT criada
            }
        }

        self.surfistas_registrados[wallet_address] = surfista_data

        # Retornar resposta formatada
        return {
            "sucesso": True,
            "transacao": f"0x{''.join(['a1b2c3d4'] * 8)}",  # Hash simulado
            "nft_id": nft_id,
            "mensagem": f"""
üéä SURFISTA RESGATADO COM SUCESSO!
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üèÑ Nome: {nome_final}
üÜî NFT ID: #{nft_id}
üìç Carteira: {wallet_address}

üéÅ B√îNUS DE RESGATE:
‚Ä¢ 100 pontos iniciais
‚Ä¢ Badge: üèÑ Flow Master
‚Ä¢ NFT √∫nica registrada na blockchain

üìä STATUS INICIAL:
‚Ä¢ Profundidade: 200m (Zona Abissal)
‚Ä¢ Energia: 0%
‚Ä¢ Objetivo: Gastar FLOW para subir!

üí° DICA: Cada comando e explora√ß√£o adiciona conhecimento √† sua bag!
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
            """
        }

    def adicionar_conhecimento(
        self,
        wallet_address: str,
        tipo: str,
        descricao: str,
        pontos: int
    ) -> bool:
        """
        Adiciona conhecimento √† bag do surfista

        Args:
            wallet_address: Endere√ßo da carteira
            tipo: Tipo do conhecimento (comando, arquivo, funcionalidade, tesouro)
            descricao: Descri√ß√£o do conhecimento adquirido
            pontos: Pontos ganhos
        """

        if wallet_address not in self.surfistas_registrados:
            return False

        surfista = self.surfistas_registrados[wallet_address]

        conhecimento = {
            "tipo": tipo,
            "descricao": descricao,
            "pontos": pontos,
            "timestamp": time.time()
        }

        surfista["bag_de_conhecimento"].append(conhecimento)
        surfista["pontos_total"] += pontos

        # Verificar conquistas
        self._verificar_conquistas(surfista)

        return True

    def atualizar_profundidade(self, wallet_address: str, flow_balance: float) -> Dict[str, Any]:
        """
        Atualiza a profundidade do submarino baseado no saldo FLOW
        L√ìGICA: Menos FLOW = Mais energia gasta = Mais pr√≥ximo da superf√≠cie
        """

        if wallet_address not in self.surfistas_registrados:
            return {"erro": "Surfista n√£o registrado"}

        surfista = self.surfistas_registrados[wallet_address]

        # Calcular energia e profundidade - SISTEMA CORRETO
        max_balance = 101000  # Saldo inicial aproximado
        energia_gasta = max(0, max_balance - flow_balance)  # FLOW gasto desde o in√≠cio
        percentual_energia_gasta = min(100, (energia_gasta / 1000) * 100)  # % de energia GASTA
        profundidade = max(0, 200 - (percentual_energia_gasta * 2))  # Sobe 2m por % de energia gasta

        surfista["energia_gasta"] = energia_gasta
        surfista["profundidade_atual"] = int(profundidade)

        # Verificar conquista de superf√≠cie
        if profundidade <= 10:
            surfista["conquistas"]["Rescue Complete"] = True

        return {
            "profundidade": int(profundidade),
            "energia_gasta": energia_gasta,
            "percentual_energia_gasta": percentual_energia_gasta  # Retorna % de energia GASTA
        }

    def ver_status(self, wallet_address: str) -> Optional[Dict[str, Any]]:
        """
        Retorna o status completo do surfista
        """

        if wallet_address not in self.surfistas_registrados:
            return None

        surfista = self.surfistas_registrados[wallet_address]
        profundidade = surfista["profundidade_atual"]

        # Determinar zona e status
        if profundidade <= 10:
            zona = "üåÖ Superf√≠cie"
            oxigenio = "‚úÖ O‚ÇÇ ILIMITADO"
        elif profundidade <= 50:
            zona = "‚òÄÔ∏è √Åguas rasas"
            oxigenio = "üå¨Ô∏è O‚ÇÇ Est√°vel"
        elif profundidade <= 100:
            zona = "üåä Profundidade m√©dia"
            oxigenio = "üí® O‚ÇÇ Limitado"
        elif profundidade <= 150:
            zona = "üåë Zona profunda"
            oxigenio = "ü´ß O‚ÇÇ CR√çTICO"
        else:
            zona = "üíÄ Zona abissal"
            oxigenio = "‚ö†Ô∏è RISCO DE IMPLOS√ÉO"

        return {
            "id": surfista["id"],
            "nome": surfista["nome"],
            "profundidade": profundidade,
            "zona": zona,
            "oxigenio": oxigenio,
            "energia_gasta": surfista["energia_gasta"],
            "pontos": surfista["pontos_total"],
            "conquistas": surfista["conquistas"],
            "bag_conhecimento": surfista["bag_de_conhecimento"],
            "total_conhecimentos": len(surfista["bag_de_conhecimento"])
        }

    def _verificar_conquistas(self, surfista: Dict[str, Any]):
        """
        Verifica e atualiza conquistas do surfista
        """

        bag = surfista["bag_de_conhecimento"]

        # Wave Rider - Completou o tutorial
        if len(bag) >= 5:
            surfista["conquistas"]["Wave Rider"] = True

        # Deep Diver - Explorou 5 pastas
        arquivos = [c for c in bag if c["tipo"] == "arquivo"]
        if len(arquivos) >= 5:
            surfista["conquistas"]["Deep Diver"] = True

        # Island Hopper - 10 comandos diferentes
        comandos = [c for c in bag if c["tipo"] == "comando"]
        if len(comandos) >= 10:
            surfista["conquistas"]["Island Hopper"] = True

        # Treasure Hunter - 100 pontos
        if surfista["pontos_total"] >= 100:
            surfista["conquistas"]["Treasure Hunter"] = True


def demonstrar_sistema():
    """
    Demonstra√ß√£o do sistema de NFT do Surfista
    """

    print("\n" + "="*60)
    print("üèÑ SISTEMA DE NFT DO SURFISTA - DEMONSTRA√á√ÉO")
    print("="*60)

    # Criar manager
    manager = SurfistaNFTManager()

    # Demonstrar sistema de numera√ß√£o de nomes
    print("\n1Ô∏è‚É£ DEMONSTRANDO SISTEMA DE NUMERA√á√ÉO...")
    print("-" * 40)
    print("V√°rios surfistas com o mesmo nome base:")

    # Resgatar m√∫ltiplos surfistas com mesmo nome
    nomes_teste = [
        ("Diego", "0x25f823e2a115b2dc"),
        ("Diego", "0x8b9a5d24cb3b0164"),
        ("Diego", "0x962c63b2b3b15a8b"),
        ("Maria", "0xaf074399a1d7fe55"),
        ("Diego", "0xad5a851aeb126bca"),
        ("Maria", "0xe712bbfbeeef1cfa"),
    ]

    for nome, wallet in nomes_teste:
        resultado = manager.resgatar_surfista(nome, wallet)
        nome_final = manager.surfistas_registrados[wallet]["nome"]
        print(f"‚úÖ {nome} ‚Üí {nome_final} (NFT #{manager.surfistas_registrados[wallet]['id']})")

    # Usar o primeiro Diego para o resto da demonstra√ß√£o
    print("\n2Ô∏è‚É£ DETALHES DO PRIMEIRO DIEGO...")
    print("-" * 40)

    resultado = manager.resgatar_surfista(
        nome="Jo√£o",
        wallet_address="0x123456789"
    )

    print(resultado["mensagem"])

    # Adicionar conhecimentos √† bag do primeiro Diego
    print("\n3Ô∏è‚É£ ADICIONANDO CONHECIMENTOS √Ä BAG...")
    print("-" * 40)

    conhecimentos = [
        ("comando", "Executou 'ls' para explorar", 5),
        ("arquivo", "Explorou /api/contracts", 10),
        ("funcionalidade", "Descobriu sistema de NFTs", 15),
        ("tesouro", "Encontrou tesouro escondido", 25),
        ("comando", "Executou 'flow scripts'", 5),
    ]

    for tipo, desc, pontos in conhecimentos:
        manager.adicionar_conhecimento(
            wallet_address="0x25f823e2a115b2dc",  # Primeiro Diego
            tipo=tipo,
            descricao=desc,
            pontos=pontos
        )
        print(f"‚úÖ {desc} (+{pontos} pontos)")

    # Simular gasto de FLOW e atualiza√ß√£o de profundidade
    print("\n4Ô∏è‚É£ SIMULANDO GASTO DE FLOW...")
    print("-" * 40)

    saldos_simulados = [100000, 95000, 85000, 50000, 10000]

    for saldo in saldos_simulados:
        status = manager.atualizar_profundidade("0x25f823e2a115b2dc", saldo)
        print(f"üí∞ Saldo: {saldo:,} FLOW ‚Üí üìç Profundidade: {status['profundidade']}m")

    # Ver status final do primeiro Diego
    print("\n5Ô∏è‚É£ STATUS FINAL DOS SURFISTAS...")
    print("-" * 40)

    status_final = manager.ver_status("0x25f823e2a115b2dc")

    if status_final:
        print(f"""
üèÑ {status_final['nome']} (NFT #{status_final['id']})
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìä STATUS:
‚Ä¢ Profundidade: {status_final['profundidade']}m
‚Ä¢ Zona: {status_final['zona']}
‚Ä¢ Oxig√™nio: {status_final['oxigenio']}
‚Ä¢ Pontos: {status_final['pontos']}
‚Ä¢ Conhecimentos: {status_final['total_conhecimentos']}

üèÜ CONQUISTAS:
""")
        for conquista, desbloqueada in status_final['conquistas'].items():
            if desbloqueada:
                print(f"  ‚úÖ {conquista}")

        print("\nüìö BAG DE CONHECIMENTO:")
        for i, conhecimento in enumerate(status_final['bag_conhecimento'][-5:], 1):
            print(f"  {i}. [{conhecimento['tipo']}] {conhecimento['descricao']} (+{conhecimento['pontos']})")

    print("\n" + "="*60)
    print("üéØ NFT do Surfista salva todo o progresso na blockchain!")
    print("üí° Continue explorando para adicionar mais conhecimento!")
    print("="*60)


if __name__ == "__main__":
    demonstrar_sistema()